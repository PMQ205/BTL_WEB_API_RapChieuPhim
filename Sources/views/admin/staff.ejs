<%- include('../partials/head') %>
<%- include('../partials/nav') %>

<div class="section" style="min-height: 80vh;">
  <div class="container admin-layout">
    <!-- Sidebar menu tái sử dụng giống index (có thể include riêng) -->
    <div class="admin-sidebar">
      <h2>Quản trị hệ thống</h2>
      <ul class="admin-menu">
        <% const perms = userPermissions || []; %>

        <% if (user.role === 1 || perms.includes('USER_MANAGE')) { %>
          <li><a href="/admin/staff" class="active">Phân quyền nhân viên</a></li>
        <% } %>

        <% if (user.role === 1 || perms.includes('MOVIE_MANAGE')) { %>
          <li><a href="/admin/movies">Quản lý phim</a></li>
        <% } %>

        <% if (user.role === 1 || perms.includes('ROOM_MANAGE')) { %>
          <li><a href="/admin/rooms">Quản lý phòng chiếu</a></li>
        <% } %>

        <% if (user.role === 1 || perms.includes('SHOWTIME_MANAGE')) { %>
          <li><a href="/admin/showtimes">Quản lý lịch chiếu</a></li>
        <% } %>

        <% if (user.role === 1 || perms.includes('SERVICE_MANAGE')) { %>
          <li><a href="/admin/services">Quản lý dịch vụ</a></li>
        <% } %>

        <% if (user.role === 1 || perms.includes('TICKET_VIEW')) { %>
          <li><a href="/admin/tickets">Quản lý vé</a></li>
        <% } %>

        <% if (user.role === 1 || perms.includes('TMP_TRANSACTION_VIEW')) { %>
          <li><a href="/admin/tmp-transactions">Quản lý giao dịch tạm</a></li>
        <% } %>

        <% if (user.role === 1 || perms.includes('REPORT_VIEW')) { %>
          <li><a href="/admin/reports">Báo cáo doanh thu</a></li>
        <% } %>
      </ul>
    </div>

    <div class="admin-content" style="display: grid; grid-template-columns: 3fr 2fr; gap: 1.5rem;">
      <!-- Bảng nhân viên -->
      <div>
        <h3>Danh sách nhân viên</h3>
        <table class="admin-table">
          <thead>
            <tr>
              <th>Mã NV</th>
              <th>Tên</th>
              <th>SĐT</th>
              <th>Email</th>
              <th>Chức vụ</th>
              <th>Cấp quyền</th>
              <th>Sửa</th>
              <th>Xóa</th>
            </tr>
          </thead>
          <tbody>
            <% staffList.forEach(nv => { %>
              <tr class="<%= selectedId === nv.MaKH ? 'selected-row' : '' %>">
                <td><%= nv.MaKH %></td>
                <td><%= nv.TenKH %></td>
                <td><%= nv.SDT || '-' %></td>
                <td><%= nv.Email || '-' %></td>
                <td>Nhân viên</td>
                <td>
                  <a href="/admin/staff?staffId=<%= nv.MaKH %>" class="btn btn-sm">Cấp quyền</a>
                </td>
                <td>
                  <a href="/admin/staff?staffId=<%= nv.MaKH %>#edit-info" class="btn btn-sm">Sửa</a>
                </td>
                <td>
                  <form method="POST" action="/admin/staff/<%= nv.MaKH %>/delete" onsubmit="return confirm('Xóa nhân viên này?');">
                    <button type="submit" class="btn btn-sm btn-danger">Xóa</button>
                  </form>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>

        <!-- Form thêm nhân viên -->
        <h4 style="margin-top: 1.5rem;">Thêm nhân viên</h4>
        <form method="POST" action="/admin/staff/add" class="admin-form-grid">
          <input type="text" name="TenKH" placeholder="Họ tên" required>
          <input type="text" name="SDT" placeholder="Số điện thoại">
          <input type="email" name="Email" placeholder="Email" required>
          <input type="text" name="TenDangNhap" placeholder="Tên đăng nhập" required>
          <input type="password" name="MatKhau" placeholder="Mật khẩu" required>
          <button type="submit" class="btn btn-hover" style="grid-column: 1/-1;">Tạo nhân viên</button>
        </form>
      </div>

      <!-- Bảng quyền -->
      <div>
        <h3>Danh sách quyền hạn</h3>
        <% if (!selectedId) { %>
          <p>Hãy chọn một nhân viên để cấp quyền.</p>
        <% } else { %>
          <form method="POST" action="/admin/staff/<%= selectedId %>/permissions">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Mã quyền</th>
                  <th>Tên quyền</th>
                  <th>Trạng thái</th>
                  <th>Chọn</th>
                </tr>
              </thead>
              <tbody>
                <% allPermissions.forEach(q => { 
                     const isGranted = selectedPermissions.includes(q.MaQuyen);
                %>
                  <tr>
                    <td><%= q.MaCode %></td>
                    <td><%= q.TenQuyen %></td>
                    <td>
                      <% if (isGranted) { %>
                        <span class="badge badge-success">Đã cấp</span>
                      <% } else { %>
                        <span class="badge badge-secondary">Chưa cấp</span>
                      <% } %>
                    </td>
                    <td style="text-align: center;">
                      <input type="checkbox" name="permissions" value="<%= q.MaQuyen %>" <%= isGranted ? 'checked' : '' %> >
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
            <div style="margin-top: 1rem; display: flex; gap: 0.75rem;">
              <button type="submit" class="btn btn-hover">Xác nhận</button>
              <a href="/admin/staff" class="btn btn-sm">Đóng</a>
            </div>
          </form>

          <!-- Bảng cập nhật thông tin nhân viên -->
          <h4 id="edit-info" style="margin-top: 1.5rem;">Cập nhật thông tin nhân viên</h4>
          <% const nvSelected = staffList.find(nv => nv.MaKH === selectedId); %>
          <% if (nvSelected) { %>
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Trường</th>
                  <th>Hiện tại</th>
                  <th>Giá trị mới</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Họ tên</td>
                  <td><%= nvSelected.TenKH %></td>
                  <td>
                    <form method="POST" action="/admin/staff/<%= nvSelected.MaKH %>/update">
                      <input type="text" name="TenKH" placeholder="Để trống nếu giữ nguyên">
                  </td>
                </tr>
                <tr>
                  <td>SĐT</td>
                  <td><%= nvSelected.SDT || '-' %></td>
                  <td>
                      <input type="text" name="SDT" placeholder="Để trống nếu giữ nguyên">
                  </td>
                </tr>
                <tr>
                  <td>Email</td>
                  <td><%= nvSelected.Email || '-' %></td>
                  <td>
                      <input type="email" name="Email" placeholder="Để trống nếu giữ nguyên">
                  </td>
                </tr>
              </tbody>
            </table>
            <div style="margin-top: 1rem; display: flex; gap: 0.75rem;">
              <button type="submit" class="btn btn-hover">Xác nhận cập nhật</button>
              <a href="/admin/staff?staffId=<%= nvSelected.MaKH %>" class="btn btn-sm">Hủy bỏ</a>
            </div>
            </form>
          <% } %>
        <% } %>
      </div>
    </div>
  </div>
</div>

<%- include('../partials/footer', { footerMenus: [] }) %>
<%- include('../partials/scripts') %>

<style>
  .admin-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }
  .admin-table th, .admin-table td {
    border-bottom: 1px solid rgba(255,255,255,0.1);
    padding: 0.5rem 0.75rem;
  }
  .admin-table th {
    background: rgba(255,255,255,0.05);
  }
  .selected-row {
    background: rgba(255,255,255,0.05);
  }
  .admin-form-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0,1fr));
    gap: 0.75rem;
    margin-top: 0.5rem;
  }
  .admin-form-grid input {
    padding: 0.4rem 0.6rem;
    border-radius: 6px;
    border: none;
    outline: none;
  }
  .btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
  }
  .btn-danger {
    background: #e53935;
  }
  .badge {
    padding: 0.15rem 0.45rem;
    border-radius: 999px;
    font-size: 0.7rem;
  }
  .badge-success {
    background: #43a047;
  }
  .badge-secondary {
    background: rgba(255,255,255,0.2);
  }
</style>